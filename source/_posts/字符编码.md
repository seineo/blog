---
title: 字符编码——从Go的字符串遍历说起
date: 2023-11-21 19:40:04
tags:
---

## Go引例

Go语言遍历字符串有两种方式，一是按下标遍历，二是for range遍历。以下面的代码片段为例，我们研究两者的不同之处。

```go
str := "I love Go"
fmt.Println("index loop:")
for i := 0; i < len(str); i++ {
  fmt.Printf("%x ", str[i])
}
fmt.Println()
fmt.Println("range loop:")
for _, char := range str {
  fmt.Printf("%x ", char)
}
```

输出为：

```shell
index loop:
49 20 6c 6f 76 65 20 47 6f 
range loop:
49 20 6c 6f 76 65 20 47 6f 
```

这样使用下来似乎没有什么区别， 但是如果我们让字符串中的字符类型更“丰富”，结果就不一样了，比如：

```go
str := "我爱Go"
fmt.Println("index loop:")
for i := 0; i < len(str); i++ {
  fmt.Printf("%x ", str[i])
}
fmt.Println()
fmt.Println("range loop:")
for _, char := range str {
  fmt.Printf("%x ", char)
}
```

输出变为：

```shell
index loop:
e6 88 91 e7 88 b1 47 6f 
range loop:
6211 7231 47 6f 
```

为什么两种遍历方式得到的“字符”数量与值都不同呢？通过查阅[官方博客](https://go.dev/blog/strings)，我们可以得到答案。

**Go语言将字符串按UTF-8编码后存储为字节数组**。下标遍历，则获取字符串的每一个字节，而for range遍历则是获取字符串中的每一个码位（code point），一个码位可能对应一个或多个字节，因此上述两种情况的结果不同。

看到这里，你或许仍然不理解为什么。这涉及字符编码的问题，接下来让我们一次性弄懂字符编码，再回顾这个例子。

## ASCII

最初常用的字符集是ASCII，其编码表如下，`Dec`代表十进制的值，`Char`代表要编码的字符。

<img src="https://oss.seineo.cn/images/202311221055209.png" alt="image-20231122105551156" style="zoom: 33%;" />

由表可知，ASCII通过7个bit覆盖了英文的所有字符、标点以及一些不可见的控制字符。现在电脑一般存储最小单位是字节，因此使用一个字节即可表示一个ASCII编码的字符。

## Unicode

英文可以通过ASCII轻松地编码，但是亚洲语言的字词更丰富，不可能放进一个字节中。之前一般会通过一个叫DBCS（Double Byte Character Set）的字符集解决，有的字符用一个字节存储，有的用两个，这导致程序员如果习惯性的通过下标访问就会出现问题，这一字符集不同的系统有着专门的函数（如windows的AnsiNext、AnsiPrev）去处理这一团糟的编码。

为了统一编码标准，Unicode被提出。**Unicode并不是一个具体的编码方式，而是一种编码思想。**

- 之前的字符编码：将一个字符映射到一串比特，如A -> `0100 0001`。
- Unicode：将一个字符映射到一个码位（code point），如 A ->`U+0041`。

码位的具体编码方式又分为了UTF-16、UTF-32、UTF-8等等。

最初每个码位就是两个字节存储的（UTF-16），这也就造成了大家**常有的错误观念：Unicode就是一种将字符编码为两个字节的编码方式**。使用两个字节编码一个字符则需要考虑字节序的问题，人们引入BOM（Byte Order Mark），将`FE FF`放到字节流的开头，如果读取出来是`FE FF`则说明机器是大端序，如果是`FF FE`则是小端序，需要交换字节来获取正确的字符。

## UTF-8

由于使用英语的国家用不到U+00FF以上的字符，因此他们认为强制两字节过于浪费空间，这就出现了UTF-8。UTF-8是变长编码，对于0～127的码位只是用一个字节来存储，适配了ASCII，大于等于128的则用2～4个字节存储。

如何实现变长呢？ 读取第一个字节就知道会有几个字节，如编解码表所示。

现在UTF-8是最常用的编码方式。 除了向后兼容ASCII以外，不用考虑字节序也是UTF-8的优点之一。

UFT-8面向字节，以一个字节为单位读写，因此不需要。

UTF-16以两个字节为单位读写，则需要考虑 （画个图对比下）

## 参考

- [The Absolute Minimum Every Software Developer Absolutely, Positively Must Know About Unicode and Character Sets (No Excuses!) – Joel on Software](https://www.joelonsoftware.com/2003/10/08/the-absolute-minimum-every-software-developer-absolutely-positively-must-know-about-unicode-and-character-sets-no-excuses/)
- https://stackoverflow.com/questions/3833693/isn-t-on-big-endian-machines-utf-8s-byte-order-different-than-on-little-endian



